name: Godot CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.5

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Godot
      run: |
        mkdir -v -p ~/.local/share/godot/export_templates/
        mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable || true
      env:
        GODOT_VERSION: "4.5"

    - name: Import and build project
      run: |
        echo "Importing project to regenerate .godot cache..."
        godot --headless --editor --quit
        echo "Import completed, waiting for cache generation..."
        sleep 2

    - name: Validate project
      run: |
        echo "Validating project scripts and resources..."
        godot --headless --script-list --quit 2>&1 | tee validation.log

        # Ignorar warnings de UID (normales en CI sin cache)
        if grep -i "^ERROR:" validation.log | grep -v "resources still in use" | grep -v "ObjectDB instances leaked"; then
          echo "❌ Errors found in project!"
          cat validation.log
          exit 1
        fi

        echo "✅ Project validation successful!"
